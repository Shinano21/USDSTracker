<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="images/USDS.png">
    <link rel="stylesheet" href="css/view.css">
    <title>View Proposal</title>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <button class="back-to-dashboard-btn" onclick="goBack()" title="Back to Dashboard">‚Üê</button>
            <div class="title-wrapper">
                <h1>View Proposal</h1>
                <div class="datetime" id="datetime"></div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="dashboard.html" data-page="dashboard.html">Dashboard</a></li>
            <li><a href="report_generation.html" data-page="report_generation.html">Reports</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1T5qHMQAFBd1c6ZJOF91v3moXKI5rhpvKL68u3mrjplc/edit?usp=sharing" target="_blank" data-page="sheets">Sheets</a></li>
            <li><a href="#" class="logout-btn" onclick="showLogoutModal()">Logout</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="container">
            <h2>View Proposal</h2>
            <div class="section">
                <div class="section-title">Proposal Details</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Proposal ID</div>
                        <div class="value" id="proposalId"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Title of Activity</div>
                        <div class="value" id="particulars"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Implementing Unit</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">College</div>
                        <div class="value" id="college"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Department</div>
                        <div class="value" id="department"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">If others, please specify</div>
                        <div class="value" id="others"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Basic Information of the Activity</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Objectives</div>
                        <div class="value" id="objectives"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Nature/Classification</div>
                        <div class="value" id="nature"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Locale</div>
                        <div class="value" id="locale"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Duration of Activity</div>
                        <div class="value" id="duration"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Funding Requirement</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Funding Source</div>
                        <div class="value" id="funding"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Total Amount</div>
                        <div class="value" id="amount"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Contact and Documents</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Number/Email of Contact Person</div>
                        <div class="value" id="contact"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Scanned Copy of Documents (with signatories)</div>
                        <div class="value" id="documents"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">1st Evaluation & Review of Compliance</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Action of CSAC</div>
                        <div class="value" id="csac"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Remarks</div>
                        <div class="value" id="remarks"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Received by USDS</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">DOC. SEQ. No.</div>
                        <div class="value" id="docSeq"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">No of Copies</div>
                        <div class="value" id="copies"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Receiver</div>
                        <div class="value" id="receiver"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Date & Time</div>
                        <div class="value" id="dateTime"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Duration of Process</div>
                        <div class="value" id="durationOfProcess"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Expected Date & Time of Release</div>
                        <div class="value" id="expectedDate"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">2nd Evaluation & Review of Compliance</div>
                <div class="detail-row">
                    <div class="detail-group">
                        <div class="label">Action of USDS</div>
                        <div class="value" id="usds"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Notations</div>
                        <div class="value" id="notations"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Status</div>
                        <div class="value" id="status"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Date and Time</div>
                        <div class="value" id="statusDate"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Office Destination</div>
                        <div class="value" id="officeDestination"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">Accomplished on Time?</div>
                        <div class="value" id="accomplished"></div>
                    </div>
                    <div class="detail-group">
                        <div class="label">If Returned, Date & Time</div>
                        <div class="value" id="returnedDate"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyHKJ6-qlH4F3dLdUNuu2mcyiQHhv7kTd7cfWnqustB9nD3aquVk0xkmmp4t7Uj620/exec';
        const DASHBOARD_URL = 'dashboard.html';
        const INDEX_URL = 'index.html';
        const GUEST_URL = 'addg.html';

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndRole();
        });

        function checkAuthAndRole() {
            const authToken = localStorage.getItem('authToken');
            const userPosition = localStorage.getItem('userPosition');

            if (authToken !== 'loggedIn') {
                window.location.replace(INDEX_URL);
                return;
            }

            // Both admins and guests can view, but we can redirect guests to a different page if needed
            // For now, we'll allow both roles to view this page
            // Uncomment the following if you want to restrict guests to a different page:
            // if (userPosition !== 'admin') {
            //     window.location.replace(GUEST_URL);
            //     return;
            // }
        }

        function updateDateTime() {
            const now = new Date();
            const options = {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            document.getElementById('datetime').textContent = now.toLocaleString('en-US', options);
        }

        function showLogoutModal() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userPosition');
                window.location.href = INDEX_URL;
            }
        }

        function goBack() {
            const userPosition = localStorage.getItem('userPosition');
            // Redirect based on role: admins to dashboard, guests to addg.html
            window.location.href = userPosition === 'admin' ? DASHBOARD_URL : GUEST_URL;
        }

        async function loadProposalData() {
            const urlParams = new URLSearchParams(window.location.search);
            const proposalId = urlParams.get('proposalId');
            if (!proposalId) {
                alert('No proposal ID provided.');
                goBack();
                return;
            }

            try {
                const response = await fetch(`${API_URL}?action=getProposalById&proposalId=${encodeURIComponent(proposalId)}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Proposal not found: ' + data.message);
                    goBack();
                    return;
                }

                document.getElementById('proposalId').textContent = data.proposalId || 'N/A';
                document.getElementById('particulars').textContent = data.particulars || 'N/A';
                document.getElementById('college').textContent = data.college || 'N/A';
                document.getElementById('department').textContent = data.department || 'N/A';
                document.getElementById('others').textContent = data.others || 'N/A';
                document.getElementById('objectives').textContent = data.objectives || 'N/A';
                document.getElementById('nature').textContent = data.nature || 'N/A';
                document.getElementById('locale').textContent = data.locale || 'N/A';
                document.getElementById('duration').textContent = data.durationOfActivity || 'N/A';
                document.getElementById('funding').textContent = data.funding || 'N/A';
                document.getElementById('amount').textContent = data.amount || 'N/A';
                document.getElementById('contact').textContent = data.contact || 'N/A';
                document.getElementById('documents').textContent = data.documents || 'N/A';
                document.getElementById('csac').textContent = data.csac || 'N/A';
                document.getElementById('remarks').textContent = data.remarks || 'N/A';
                document.getElementById('docSeq').textContent = data.docSeq || 'N/A';
                document.getElementById('copies').textContent = data.copies || 'N/A';
                document.getElementById('receiver').textContent = data.receiver || 'N/A';
                document.getElementById('dateTime').textContent = data.dateTime || 'N/A';
                document.getElementById('durationOfProcess').textContent = data.durationOfProcess || 'N/A';
                document.getElementById('expectedDate').textContent = data.expectedDate || 'N/A';
                document.getElementById('usds').textContent = data.usds || 'N/A';
                document.getElementById('notations').textContent = data.notations || 'N/A';
                document.getElementById('status').textContent = data.status || 'N/A';
                document.getElementById('statusDate').textContent = data.statusDate || 'N/A';
                document.getElementById('officeDestination').textContent = data.officeDestination || 'N/A';
                document.getElementById('accomplished').textContent = data.accomplished || 'N/A';
                document.getElementById('returnedDate').textContent = data.returnedDate || 'N/A';
            } catch (error) {
                console.error('Error fetching proposal data:', error);
                alert(`Failed to load proposal data: ${error.message}`);
                goBack();
            }
        }

        window.onload = function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadProposalData();
        };

        window.history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function () {
            checkAuthAndRole();
        });
    </script>
</body>
</html>