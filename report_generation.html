<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Generation Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .header {
            background-color: #e6f3e6;
            text-align: center;
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .report-name {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
        }
        input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        .submit-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .no-data {
            color: #888;
            font-style: italic;
        }

        /* Print-specific styles */
        @media print {
            body {
                margin: 0;
            }
            .header {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact; /* For WebKit browsers (Chrome, Safari) */
                print-color-adjust: exact; /* Standard property for Firefox and others */
            }
            .report-name {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            th {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            tr:nth-child(even) {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            input {
                border: 1px solid #000;
                background-color: #fff;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .report-name label {
                display: none;
            }
            .submit-btn {
                display: none;
            }
            .no-data {
                display: none; /* Hide "No data" messages in print */
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">REPORTS GENERATION FORM</div>
    
    <div class="report-name">
        <label for="reportName">Report Name:</label>
        <input type="text" id="reportName" name="reportName" placeholder="Enter Report Name Here">
    </div>

    <table>
        <thead>
            <tr>
                <th>MONTH</th>
                <th>RECEIVED BY</th>
                <th></th>
                <th></th>
                <th></th>
                <th>RECORD OF TRANSACTIONS</th>
                <th></th>
                <th></th>
                <th>TOTAL PROPOSALS RECEIVED (BY NATURE/CLASSIFICATION)</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>TOTAL ACTED UPON SCHEDULE (ACCOMPLISHED ON TIME)</th>
            </tr>
            <tr>
                <th></th>
                <th>Maâ€™am Anna</th>
                <th>Sir Mike</th>
                <th>Sir Christian</th>
                <th>Sir Ronald</th>
                <th>Off Campus</th>
                <th>In Campus</th>
                <th>OJT</th>
                <th>Off Campus</th>
                <th>In Campus</th>
                <th>UNIBE</th>
                <th>UBO</th>
                <th>USC</th>
                <th>Yes/No (e.g., 23/34)</th>
            </tr>
        </thead>
        <tbody id="monthData">
            <!-- Months with matching Proposal IDs will be dynamically inserted here -->
        </tbody>
    </table>

    <div id="errorMessage" style="color: red; display: none;">Failed to load data. Please enter data manually or check the script URL.</div>
    <button class="submit-btn" onclick="fetchAndDisplayData()">Load Data</button>
    <button class="submit-btn" onclick="submitForm()">Submit Data</button>

    <script>
        // List of all months
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        // Function to create month rows dynamically
        function createMonthRows(proposalData) {
            const tbody = document.getElementById('monthData');
            const categories = ['maam_anna', 'sir_mike', 'sir_christian', 'sir_ronald', 'off_campus', 'in_campus', 'ojt'];
            const proposalTypes = ['off_campus', 'in_campus', 'unibe', 'ubo', 'usc'];
            tbody.innerHTML = ''; // Clear existing rows

            // Track months with data based on Proposal IDs (MM-YYYY-XXXX)
            const monthData = {};
            const accomplishedData = {}; // Track Yes/No for accomplished on time
            proposalData.forEach(proposal => {
                const proposalId = proposal.proposalId;
                if (proposalId && /^(\d{2}-\d{4}-\d{4})$/.test(proposalId)) { // Match MM-YYYY-XXXX format
                    const [month, year] = proposalId.split('-').slice(0, 2); // Extract MM and YYYY
                    const monthNum = parseInt(month, 10); // Convert MM to number (1-12)
                    if (monthNum >= 1 && monthNum <= 12) {
                        const monthName = months[monthNum - 1]; // Convert to month name
                        const monthShort = monthName.toLowerCase().substring(0, 3); // e.g., "feb"
                        if (!monthData[monthShort]) {
                            monthData[monthShort] = {};
                            categories.forEach(cat => monthData[monthShort][cat] = 0);
                            proposalTypes.forEach(type => monthData[monthShort][type] = 0);
                            accomplishedData[monthShort] = { yes: 0, total: 0 };
                        }
                        // Aggregate data for each category and proposal type
                        categories.forEach(cat => {
                            if (proposal[monthShort + '_' + cat]) {
                                monthData[monthShort][cat] += parseInt(proposal[monthShort + '_' + cat]) || 0;
                            }
                        });
                        proposalTypes.forEach(type => {
                            if (proposal[monthShort + '_' + type]) {
                                monthData[monthShort][type] += parseInt(proposal[monthShort + '_' + type]) || 0;
                            }
                        });
                        // Track accomplished on time (Yes/No)
                        if (proposal.accomplished && proposal.accomplished.toLowerCase() === 'yes') {
                            accomplishedData[monthShort].yes += 1;
                            accomplishedData[monthShort].total += 1;
                        } else if (proposal.accomplished) {
                            accomplishedData[monthShort].total += 1;
                        }
                    }
                }
            });

            // Create rows for months with data
            months.forEach((month, index) => {
                const monthShort = month.toLowerCase().substring(0, 3);
                if (monthData[monthShort]) {
                    const row = document.createElement('tr');

                    // Month cell
                    row.innerHTML = `<td>${month}</td>`;

                    // Add input cells for each category with fetched data
                    categories.forEach(category => {
                        const value = monthData[monthShort][category] || 0;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.name = `${monthShort}_${category}`;
                        input.value = value; // Pre-fill with fetched data
                        input.addEventListener('input', calculateTotals);
                        row.innerHTML += `<td>${input.outerHTML}</td>`;
                    });

                    // Add input cells for proposal types (Off Campus, In Campus, UNIBE, UBO, USC)
                    proposalTypes.forEach(type => {
                        const value = monthData[monthShort][type] || 0;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.name = `${monthShort}_${type}`;
                        input.value = value; // Pre-fill with fetched data
                        input.addEventListener('input', calculateTotals);
                        row.innerHTML += `<td>${input.outerHTML}</td>`;
                    });

                    // Total proposals cell (sum of Off Campus, In Campus, UNIBE, UBO, USC)
                    const totalProposals = proposalTypes.reduce((sum, type) => sum + (parseInt(monthData[monthShort][type]) || 0), 0);
                    const totalInput = document.createElement('input');
                    totalInput.type = 'number';
                    totalInput.name = `${monthShort}_total`;
                    totalInput.value = totalProposals;
                    totalInput.readOnly = true;
                    row.innerHTML += `<td>${totalInput.outerHTML}</td>`;

                    // Total Acted Upon Schedule (Accomplished On Time) - Yes/No fraction
                    const yesCount = accomplishedData[monthShort].yes || 0;
                    const totalCount = accomplishedData[monthShort].total || 0;
                    const actedUponInput = document.createElement('input');
                    actedUponInput.type = 'text';
                    actedUponInput.name = `${monthShort}_acted_upon`;
                    actedUponInput.value = totalCount > 0 ? `${yesCount}/${totalCount}` : '0/0';
                    actedUponInput.readOnly = true;
                    row.innerHTML += `<td>${actedUponInput.outerHTML}</td>`;

                    tbody.appendChild(row);
                }
            });

            // Add TOTAL row
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                ${categories.map(category => `<td><input type="number" name="total_${category}" placeholder="0" readonly></td>`).join('')}
                ${proposalTypes.map(type => `<td><input type="number" name="total_${type}" placeholder="0" readonly></td>`).join('')}
                <td><input type="number" name="total_grand" placeholder="0" readonly></td>
                <td><input type="text" name="total_acted_upon" placeholder="0/0" readonly></td>
            `;
            tbody.appendChild(totalRow);
        }

        // Function to calculate totals
        function calculateTotals() {
            const categories = ['maam_anna', 'sir_mike', 'sir_christian', 'sir_ronald', 'off_campus', 'in_campus', 'ojt'];
            const proposalTypes = ['off_campus', 'in_campus', 'unibe', 'ubo', 'usc'];
            const rows = document.querySelectorAll('#monthData tr:not(:last-child)');

            // Calculate totals for Received By and Record of Transactions
            categories.forEach(category => {
                let total = 0;
                rows.forEach(row => {
                    const value = parseInt(row.querySelector(`input[name$="_${category}"]`)?.value) || 0;
                    total += value;
                });
                document.querySelector(`input[name="total_${category}"]`).value = total;
            });

            // Calculate totals for proposal types
            proposalTypes.forEach(type => {
                let total = 0;
                rows.forEach(row => {
                    const value = parseInt(row.querySelector(`input[name$="_${type}"]`)?.value) || 0;
                    total += value;
                });
                document.querySelector(`input[name="total_${type}"]`).value = total;
            });

            // Calculate grand total for proposals (sum of all proposal types)
            let grandTotal = 0;
            proposalTypes.forEach(type => {
                const total = parseInt(document.querySelector(`input[name="total_${type}"]`)?.value) || 0;
                grandTotal += total;
            });
            document.querySelector(`input[name="total_grand"]`).value = grandTotal;

            // Calculate total acted upon schedule (sum of Yes/No fractions across months)
            let totalYes = 0;
            let totalProposals = 0;
            rows.forEach(row => {
                const actedUponValue = row.querySelector('input[name$="_acted_upon"]')?.value || '0/0';
                const [yes, total] = actedUponValue.split('/').map(num => parseInt(num) || 0);
                totalYes += yes;
                totalProposals += total;
            });
            document.querySelector(`input[name="total_acted_upon"]`).value = totalProposals > 0 ? `${totalYes}/${totalProposals}` : '0/0';
        }

        // Function to fetch and display data from Google Apps Script
        async function fetchAndDisplayData() {
            try {
                const response = await fetch('https://cors-anywhere.herokuapp.com/https://script.google.com/macros/s/AKfycbyHKJ6-qlH4F3dLdUNuu2mcyiQHhv7kTd7cfWnqustB9nD3aquVk0xkmmp4t7Uj620/exec?action=getData', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors' // Ensure CORS is handled correctly
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                if (data && Array.isArray(data)) {
                    createMonthRows(data);
                    calculateTotals(); // Recalculate totals after loading data
                    alert('Data loaded successfully!');
                } else {
                    alert('No data found or error loading data: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Fetch error details:', error);
                alert('Error fetching data: ' + error.message + (error.stack ? '\nStack: ' + error.stack : ''));
            }
        }

        // Function to submit form data to Google Apps Script
        async function submitForm() {
            const reportName = document.getElementById('reportName').value;
            if (!reportName) {
                alert('Please enter a Report Name before submitting.');
                return;
            }

            const data = {
                action: "add",
                particulars: reportName,
                college: "",
                department: "",
                others: "",
                objectives: "",
                nature: "",
                locale: "",
                duration: "",
                funding: "",
                amount: "",
                contact: "",
                documents: "",
                csac: "",
                remarks: "",
                docSeq: "",
                copies: "",
                receiver: "",
                usds: "",
                notations: ""
            };

            // Collect data from the form inputs for months with entries
            const rows = document.querySelectorAll('#monthData tr:not(:last-child)');
            const categories = ['maam_anna', 'sir_mike', 'sir_christian', 'sir_ronald', 'off_campus', 'in_campus', 'ojt'];
            const proposalTypes = ['off_campus', 'in_campus', 'unibe', 'ubo', 'usc'];

            rows.forEach(row => {
                const monthInputs = row.querySelectorAll('input[type="number"]');
                let hasData = false;
                const monthShort = row.cells[0].textContent.toLowerCase().substring(0, 3);

                // Collect data for Received By and Record of Transactions
                categories.forEach((category, index) => {
                    const value = monthInputs[index].value;
                    if (value && parseInt(value) > 0) {
                        hasData = true;
                        data[`${monthShort}_${category}`] = parseInt(value) || 0;
                    }
                });

                // Collect data for proposal types
                let proposalIndex = categories.length;
                proposalTypes.forEach(type => {
                    const value = monthInputs[proposalIndex].value;
                    if (value && parseInt(value) > 0) {
                        hasData = true;
                        data[`${monthShort}_${type}`] = parseInt(value) || 0;
                    }
                    proposalIndex++;
                });

                // Collect accomplished on time (Yes/No) - simplified for user input
                const actedUponValue = row.querySelector('input[name$="_acted_upon"]')?.value || '0/0';
                const [yes, total] = actedUponValue.split('/').map(num => parseInt(num) || 0);
                if (total > 0) {
                    data[`${monthShort}_accomplished`] = yes === total ? 'Yes' : 'No'; // Simplified logic; adjust based on actual data
                }

                if (hasData) {
                    const total = monthInputs[monthInputs.length - 2].value; // Total proposals (before acted upon)
                    if (total) {
                        data[`${monthShort}_total`] = parseInt(total) || 0;
                    }
                }
            });

            try {
                const response = await fetch('https://cors-anywhere.herokuapp.com/https://script.google.com/macros/s/AKfycbyHKJ6-qlH4F3dLdUNuu2mcyiQHhv7kTd7cfWnqustB9nD3aquVk0xkmmp4t7Uj620/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                if (result.success) {
                    alert('Data submitted successfully! Row: ' + result.row);
                    // Optionally clear or reset the form after submission
                    document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                    document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                    document.getElementById('reportName').value = '';
                    createMonthRows([]); // Clear displayed data
                    calculateTotals(); // Recalculate totals after reset
                } else {
                    alert('Error submitting data: ' + result.message);
                }
            } catch (error) {
                console.error('Fetch error details:', error);
                alert('Error submitting data: ' + error.message + (error.stack ? '\nStack: ' + error.stack : ''));
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayData().catch(() => {
                document.getElementById('errorMessage').style.display = 'block';
                createMonthRows([]); // Show empty form for manual entry
                calculateTotals();
            });
        });
    </script>
</body>
</html>